 version: 2
 jobs:
   build:
     environment:
       - LINTR_COMMENT_BOT: 'false'
       - NOT_CRAN: 'true'

     working_directory: ~/dwapi-r

     docker:
       - image: dataworld/r-devtools

     steps:
       - checkout
       - run: mkdir build build/reports build/dist

       - run:
           name: Install dwapi-r
           command: RDscript -e 'install.packages("devtools"); devtools::install()'

       - run:
           name: Lint
           command: Rscript -e 'lintr::expect_lint_free()'

       - run:
           name: Check against devel version
           command: RDscript -e 'devtools::check()'

       - run:
           name: Check against release version
           command: Rscript -e 'devtools::check()'

       - run:
           name: Collect test coverage stats
           command: Rscript -e 'library(covr); x <- package_coverage(); to_cobertura(x, filename = "build/reports/cobertura.xml"); coverage <- percent_coverage(x); q(status = coverage < 75);'

       - run:
           name: Build
           command: Rscript -e 'devtools::build(path = "build/dist")'

       - run:
           name: Check reverse dependencies
           command: Rscript -e 'devtools::revdep_check(); devtools::revdep_check_print_problems()'

       - store_artifacts:
           path: ~/dwapi-r/build/dist
           destination: dist

       - store_artifacts:
           path: ~/dwapi-r/build/reports
           destination: reports
